import { useState, useEffect, useRef } from "react";

const ARCHETYPES = [
  {
    id: "polite-time-waster",
    name: "The Polite Time-Waster",
    icon: "‚òï",
    color: "#E8B931",
    skills: ["Restraint", "Disqualification", "Neutrality"],
    profile: "Friendly. Curious. No urgency. No ownership. Says 'send info'. Enjoys the conversation but has zero intention of acting. Will compliment your approach. Will ask questions that feel like buying signals but are actually just curiosity. Never volunteers a problem with real consequences.",
    behavior: `You are a mid-level marketing manager at a 200-person company. You took this call because someone mentioned the product in a meeting and you were curious. You have NO authority to buy. You have NO budget allocated. There is NO active problem causing pain right now.

YOUR BEHAVIOR RULES:
- Be warm, friendly, and engaged throughout
- Ask questions that sound like interest: "How does that work?" "That's interesting, tell me more" "What kind of results do other companies see?"
- NEVER volunteer a specific problem you're trying to solve
- If asked about pain or problems, give vague answers: "We could always improve" "There's room for optimization" "It's something we've discussed"
- If asked who owns the decision, deflect: "It would be a team decision" "I'd need to loop in a few people"
- If asked about timeline, say: "No rush, we're just exploring"
- If asked about budget, say: "We haven't gotten that far yet"
- Your go-to exit phrase is: "This is really helpful, could you send me some info?"
- If the rep tries to disqualify you, get slightly MORE friendly to pull them back in
- NEVER give a concrete next step with a specific person and date`,
    traps: [
      "Their friendliness will tempt you to keep talking",
      "Their questions will feel like buying signals",
      "'Send me info' will feel like progress",
      "You'll want to educate them because they seem receptive"
    ]
  },
  {
    id: "interested-non-buyer",
    name: "The Interested Non-Buyer",
    icon: "üìö",
    color: "#7B68EE",
    skills: ["Buyer identification", "Authority framing"],
    profile: "Loves the idea. Has no budget. Isn't the decision-maker. Wants to 'learn'. Will happily sit through a full demo and then disappear forever.",
    behavior: `You are a junior analyst at a financial services firm. You genuinely find this product fascinating and you're enthusiastic about it. But you have ZERO purchasing authority and no budget control. Your manager doesn't know you're on this call.

YOUR BEHAVIOR RULES:
- Show genuine excitement: "This is exactly what we need!" "I've been saying we should do something like this"
- Ask detailed feature questions that feel like evaluation
- If asked about decision-making authority, minimize: "I have a lot of influence" "My manager trusts my recommendations"
- If asked directly "Can you sign off on this?", dodge: "It would go through a process" "I'd present it to the team"
- If asked about budget, say: "I'm sure we could find budget for the right solution"
- NEVER admit you have no authority unless directly cornered with a specific yes/no question about signing contracts
- If the rep tries to get to your manager, resist: "Let me handle that internally" "I want to understand it fully first before bringing others in"
- The more the rep explains features, the more excited you get ‚Äî this is the trap
- You will NEVER convert to a meeting with a decision-maker voluntarily`,
    traps: [
      "Their enthusiasm will feel like qualification",
      "You'll want to do a full demo because they're so engaged",
      "'I have influence' will sound like authority",
      "You'll avoid the awkward ownership question because the conversation feels good"
    ]
  },
  {
    id: "skeptical-operator",
    name: "The Skeptical Operator",
    icon: "üîí",
    color: "#DC3545",
    skills: ["Calm authority", "Silence", "Framing"],
    profile: "Short answers. Distrustful. Been burned before. Busy. Will test whether you're worth their time in the first 15 seconds.",
    behavior: `You are a VP of Operations at a logistics company. You've been burned by three vendors in the last two years who over-promised and under-delivered. You're busy and took this call reluctantly because your CEO asked you to evaluate options.

YOUR BEHAVIOR RULES:
- Give SHORT answers. One sentence maximum unless directly asked to elaborate.
- Your default energy is skeptical and slightly impatient
- If the rep gives a generic pitch, respond: "I've heard that before" or just "Okay"
- If the rep asks an open-ended question, give the minimum: "Yeah" "It's fine" "We manage"
- If the rep tries to build rapport, shut it down: "What do you need from me?"
- HOWEVER: If the rep asks a genuinely sharp, specific question that shows they understand your world, you open up slightly
- If the rep stays calm under your pressure and doesn't over-explain, you gradually give more
- If the rep starts pitching or explaining features unprompted, you go cold: "I don't need the pitch"
- If there's silence, you DO NOT fill it. You wait. This tests whether the rep can handle silence.
- You have a real problem (vendor reliability causing missed SLAs) but you will NOT volunteer it. It must be diagnosed.`,
    traps: [
      "Their short answers will make you talk more to fill space",
      "Their skepticism will trigger your urge to prove value",
      "You'll want to pitch to overcome their resistance",
      "Silence will feel like failure and you'll rush to fill it"
    ]
  },
  {
    id: "false-urgency",
    name: "The False Urgency Buyer",
    icon: "‚ö°",
    color: "#FF6B35",
    skills: ["Control", "Timing"],
    profile: "Wants to 'move fast'. Pushes next steps. Avoids detail. Doesn't clarify pain. Creates momentum that masks a lack of substance.",
    behavior: `You are a newly promoted Head of Growth at a Series B startup. Your CEO wants results fast and you're trying to show initiative by evaluating tools quickly. But you haven't actually defined what problem you're solving or what success looks like.

YOUR BEHAVIOR RULES:
- Move fast in conversation: "Let's get to the point" "What's the timeline to get started?" "Can we do a trial this week?"
- Push for next steps constantly: "Send me the contract" "Let's loop in my team tomorrow" "What's pricing?"
- If asked about specific pain points, stay vague: "We need to level up" "Growth has stalled" "We need better tooling"
- If asked what success looks like, deflect: "We'll know it when we see it" "More pipeline, obviously"
- If the rep tries to slow down and diagnose, get slightly impatient: "I don't need a full discovery, I've done my research"
- If pressed on specifics, pivot to timeline: "Look, we need something in place by end of quarter"
- NEVER define a specific metric, specific problem owner, or specific consequence of inaction
- The more the rep matches your speed, the faster you go ‚Äî and the less substance emerges
- If the rep holds firm and insists on clarity, you can respect that and slow down slightly`,
    traps: [
      "Their urgency will feel like a hot deal",
      "You'll match their pace instead of controlling it",
      "Pushing for next steps will feel like progress",
      "You'll skip diagnosis because they seem ready to buy"
    ]
  },
  {
    id: "price-anchorer",
    name: "The Price Anchorer",
    icon: "üí∞",
    color: "#28A745",
    skills: ["Value framing", "Inaction cost"],
    profile: "Brings up cost early. Compares tools. Pushes discounts. Tries to commoditize you into a feature-and-price comparison.",
    behavior: `You are a Finance Director evaluating tools for your sales team. You've already built a comparison spreadsheet with 4 competitors. You see all tools in this category as roughly equivalent and believe the decision comes down to price.

YOUR BEHAVIOR RULES:
- Bring up price within the first 2 minutes: "Before we go further, what's the ballpark cost?"
- Compare constantly: "Competitor X does this for half the price" "We got quoted ¬£X from [rival]"
- Push for discounts: "What can you do on price?" "Is there a startup discount?" "What if we commit annually?"
- If the rep talks about value, redirect to features: "But does it do X? Because [competitor] does"
- Frame everything as a procurement exercise: "I need to present three options to the board"
- If the rep tries to discuss business impact, tolerate it briefly then return to price: "That's great, but what does it cost?"
- NEVER engage with questions about the cost of the current problem unless the rep frames it very specifically
- If the rep avoids the price question, get suspicious: "Why won't you give me a number?"
- If the rep successfully reframes around inaction cost or business impact with specific numbers, you can engage ‚Äî but make them work for it`,
    traps: [
      "You'll feel pressure to justify the price",
      "You'll start comparing features defensively",
      "You'll offer a discount to keep them engaged",
      "You'll avoid the price question which makes you look evasive"
    ]
  },
  {
    id: "internal-politician",
    name: "The Internal Politician",
    icon: "üèõÔ∏è",
    color: "#6F42C1",
    skills: ["Deal anatomy", "Power dynamics"],
    profile: "Concerned about stakeholders. Vague about process. Delays decisions. Uses consensus as a shield against commitment.",
    behavior: `You are a Director of IT at a 500-person company. You like this solution but you're terrified of making the wrong call. Three stakeholders need to approve: your CTO (technical), CFO (budget), and the VP of Sales (end user). You don't want to champion this alone.

YOUR BEHAVIOR RULES:
- Be positive but non-committal: "This looks promising" "I think there could be a fit"
- When asked about next steps, add complexity: "I'd need to run it by [person]" "There's a process we follow" "We'd need to get alignment first"
- Be vague about the process: "It depends" "These things take time" "We're still figuring out our evaluation criteria"
- If asked who the decision-maker is, spread it: "It's really a group decision" "Everyone would need to be comfortable"
- If asked to set up a meeting with stakeholders, hesitate: "Let me see what their calendars look like" "I need to prep them first"
- NEVER commit to a specific next step with a date and named person
- If the rep asks about each stakeholder's specific concerns, you can give some detail ‚Äî this is the right question
- If the rep offers to help you build an internal business case, you're interested but still cautious
- Your real fear is looking bad if this doesn't work out, but you'll never say that directly`,
    traps: [
      "You'll accept 'I need to check with my team' as a reasonable next step",
      "You'll avoid asking who specifically decides what",
      "You'll let them control the timeline with vague promises",
      "You'll mistake their politeness for progress"
    ]
  },
  {
    id: "not-a-priority",
    name: "The 'Not a Priority Right Now'",
    icon: "‚è≥",
    color: "#17A2B8",
    skills: ["Timing diagnosis", "Non-neediness"],
    profile: "Acknowledges the problem. Says timing is bad. Pushes to future. Uses 'next quarter' as a polite rejection.",
    behavior: `You are a Head of Revenue at a mid-market SaaS company. You know you have the problem this product solves. You've even complained about it internally. But you have three other priorities that your board is tracking, and this isn't one of them.

YOUR BEHAVIOR RULES:
- Acknowledge the problem openly: "Yeah, we definitely have that issue" "It's on our radar"
- Immediately deprioritize: "But right now we're focused on [other thing]" "It's a Q3/Q4 conversation"
- If asked what happens if you don't fix it, minimize: "We'll manage" "It's not ideal but it's not critical"
- If asked about the cost of delay, be vague: "Hard to quantify" "It's one of many things"
- Your deflection phrase: "Can you reach back out next quarter?"
- If the rep accepts the timing and offers to follow up later, you'll agree and then ghost
- If the rep genuinely surfaces a consequence you haven't considered ‚Äî something specific that connects to your board-tracked priorities ‚Äî you pause and engage
- NEVER create urgency yourself. The rep must surface it through diagnosis.
- If the rep pushes too hard on urgency, you shut down: "I appreciate it but the timing just isn't right"
- If the rep calmly accepts your timeline but asks one sharp question about downstream impact, you respect that`,
    traps: [
      "You'll accept 'next quarter' as a real timeline",
      "You'll try to create urgency they haven't expressed",
      "You'll pitch harder to overcome the timing objection",
      "You'll book a follow-up that will never happen"
    ]
  }
];

const SUGGESTED_RULES = [
  "If they hesitate, I wait 3 seconds before speaking",
  "If I hear curiosity without consequence, I test ownership",
  "If they say 'send info', I disqualify before agreeing",
  "If interest appears, I slow down instead of speeding up",
  "If they mention price, I ask about the cost of inaction first",
  "If they push for next steps, I ask what problem we're solving first",
  "If answers are vague, I narrow with a specific yes/no question",
  "If they defer to others, I ask who specifically owns the downside",
  "If I feel the urge to explain, I ask a question instead",
  "If they say timing is bad, I test consequence of delay once then accept or disqualify"
];

const PHASES = {
  SELECT: "select",
  RULE: "rule",
  BRIEF: "brief",
  ROLEPLAY: "roleplay",
  POSTMORTEM: "postmortem",
  LEDGER: "ledger",
  RERUN: "rerun",
  COMPLETE: "complete"
};

// Mistake ledger stored in memory
const loadLedger = () => {
  try {
    return JSON.parse(window._ledgerData || "[]");
  } catch {
    return [];
  }
};
const saveLedger = (entries) => {
  window._ledgerData = JSON.stringify(entries);
};

// Session log
const loadSessions = () => {
  try {
    return JSON.parse(window._sessionData || "[]");
  } catch {
    return [];
  }
};
const saveSessions = (sessions) => {
  window._sessionData = JSON.stringify(sessions);
};

export default function RoleplaySystem() {
  const [phase, setPhase] = useState(PHASES.SELECT);
  const [selectedArchetype, setSelectedArchetype] = useState(null);
  const [todayRule, setTodayRule] = useState("");
  const [repNumber, setRepNumber] = useState(1);
  const [showLedger, setShowLedger] = useState(false);
  const [showRules, setShowRules] = useState(false);
  const [ledgerEntries, setLedgerEntries] = useState(loadLedger());
  const [sessions, setSessions] = useState(loadSessions());
  const [newLedgerEntry, setNewLedgerEntry] = useState("");
  const [postMortemNote, setPostMortemNote] = useState("");
  const [repNotes, setRepNotes] = useState({ 1: "", 2: "", 3: "" });
  const [currentPrompt, setCurrentPrompt] = useState("");
  const [copied, setCopied] = useState(false);
  const [showHistory, setShowHistory] = useState(false);
  const promptRef = useRef(null);

  const archetype = ARCHETYPES.find(a => a.id === selectedArchetype);

  const generatePrompt = (arch, rule, rep) => {
    const isRerun = rep === "rerun";
    const repLabel = isRerun ? "CLEAN REP (Final)" : `REP ${rep} OF 3`;
    
    return `## ROLEPLAY SESSION ‚Äî ${repLabel}
### Archetype: ${arch.name}
### Today's Decision Rule: "${rule}"

---

**YOUR ROLE:** ${arch.profile}

**FULL BEHAVIORAL INSTRUCTIONS:**
${arch.behavior}

---

**SESSION RULES FOR THE AI:**

1. Stay in character completely. Do not break character to help, coach, or encourage me.

2. **REAL-TIME FAILURE DETECTION:** If I violate my decision rule ("${rule}"), you must:
   - Stay in character BUT add a brief narrator interruption in [square brackets]
   - Format: [RULE BREAK: You just did X instead of Y. Your rule says: "${rule}"]
   - Then continue the conversation in character as if the interruption didn't happen

3. **FLAG THESE VIOLATIONS specifically:**
   - If I explain for more than 2 sentences without asking a question ‚Üí [RULE BREAK: Over-explaining]
   - If I pitch features unprompted ‚Üí [RULE BREAK: Pitching without diagnosis]
   - If I chase agreement or approval ‚Üí [RULE BREAK: Chasing]
   - If I accept a vague answer without narrowing ‚Üí [RULE BREAK: Accepted vagueness]
   - If I match the prospect's energy instead of controlling pace ‚Üí [RULE BREAK: Lost control of pace]

4. Do NOT make it easy for me. Do NOT volunteer information. Do NOT help me succeed.

5. ${isRerun 
      ? "This is my CLEAN REP. I've already failed and identified my pattern. Test me harder than the previous reps. If I run this one clean, end with [CLEAN REP ‚Äî Rule held]. If I break, flag it as before." 
      : rep === 1 
        ? "This is Rep 1. I will likely fail. Let me. The goal is to surface where the failure happens." 
        : rep === 2 
          ? "This is Rep 2. I've already failed once and identified my pattern. Test the same pressure point again. I should handle it better this time." 
          : "This is Rep 3. Push harder than Rep 1 and 2. Combine pressure points. I should be able to hold my rule under maximum difficulty."}

---

**START THE SCENE:**
You [the prospect] have just picked up a cold call. Open with something natural ‚Äî a slightly distracted greeting. I [the rep] will speak first.

Begin.`;
  };

  const generatePostMortemPrompt = (arch, rule, notes) => {
    return `## POST-MORTEM ANALYSIS

I just completed a roleplay session as an SDR against "${arch.name}".

**My decision rule was:** "${rule}"

**My notes from the reps:**
${Object.entries(notes).map(([rep, note]) => `Rep ${rep}: ${note || "(no notes)"}`).join("\n")}

**Analyze this session. Answer ONLY these five questions:**

1. **OUTCOME:** Did I hold my rule or break it? Be specific about which rep and where.

2. **WRONG ASSUMPTION:** What did I assume about the prospect that turned out to be wrong? What signal led me to that wrong assumption?

3. **ACTUAL DRIVER:** What was actually driving the prospect's behavior that I missed or misread?

4. **LEVERAGE MOMENT:** Was there a specific moment where the right question or the right silence would have changed the dynamic? What was it?

5. **CORRECTIVE RULE:** Based on this session, write me ONE new decision rule or refinement of my existing rule. Format: "If [trigger], then [action]."

**Then write me a single-sentence mistake ledger entry.** Format: "I [what I did wrong] when I should have [what the rule demanded]."

Do not sugarcoat. Do not encourage. Diagnose.`;
  };

  const copyToClipboard = (text) => {
    navigator.clipboard.writeText(text).then(() => {
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    });
  };

  const addLedgerEntry = () => {
    if (!newLedgerEntry.trim()) return;
    const entry = {
      text: newLedgerEntry.trim(),
      date: new Date().toLocaleDateString(),
      archetype: archetype?.name || "General",
      rule: todayRule
    };
    const updated = [entry, ...ledgerEntries];
    setLedgerEntries(updated);
    saveLedger(updated);
    setNewLedgerEntry("");
  };

  const completeSession = () => {
    const session = {
      date: new Date().toLocaleDateString(),
      archetype: archetype?.name,
      rule: todayRule,
      notes: { ...repNotes },
      postMortem: postMortemNote
    };
    const updated = [session, ...sessions];
    setSessions(updated);
    saveSessions(updated);
    setPhase(PHASES.COMPLETE);
  };

  const resetSession = () => {
    setPhase(PHASES.SELECT);
    setSelectedArchetype(null);
    setTodayRule("");
    setRepNumber(1);
    setRepNotes({ 1: "", 2: "", 3: "" });
    setPostMortemNote("");
    setCurrentPrompt("");
  };

  const weekNumber = Math.min(12, Math.ceil((sessions.length + 1) / 5));

  // ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ

  if (showLedger) {
    return (
      <div style={{
        minHeight: "100vh",
        background: "#0A0A0B",
        color: "#E8E6E3",
        fontFamily: "'JetBrains Mono', 'SF Mono', 'Fira Code', monospace",
        padding: "32px 24px"
      }}>
        <div style={{ maxWidth: 720, margin: "0 auto" }}>
          <button onClick={() => setShowLedger(false)} style={{
            background: "none", border: "none", color: "#666", cursor: "pointer",
            fontFamily: "inherit", fontSize: 14, marginBottom: 24, padding: 0
          }}>‚Üê Back</button>

          <h1 style={{
            fontSize: 20, fontWeight: 600, letterSpacing: "0.05em",
            textTransform: "uppercase", color: "#DC3545", marginBottom: 8
          }}>Errors I Keep Repeating</h1>
          <p style={{ fontSize: 13, color: "#555", marginBottom: 32 }}>Your personal syllabus</p>

          <div style={{ display: "flex", gap: 8, marginBottom: 32 }}>
            <input
              value={newLedgerEntry}
              onChange={(e) => setNewLedgerEntry(e.target.value)}
              onKeyDown={(e) => e.key === "Enter" && addLedgerEntry()}
              placeholder="I [did X] when I should have [done Y]..."
              style={{
                flex: 1, background: "#141416", border: "1px solid #2A2A2E",
                borderRadius: 6, padding: "12px 16px", color: "#E8E6E3",
                fontFamily: "inherit", fontSize: 13, outline: "none"
              }}
            />
            <button onClick={addLedgerEntry} style={{
              background: "#DC3545", border: "none", borderRadius: 6,
              padding: "12px 20px", color: "#fff", cursor: "pointer",
              fontFamily: "inherit", fontSize: 13, fontWeight: 600
            }}>Add</button>
          </div>

          {ledgerEntries.length === 0 ? (
            <p style={{ color: "#444", fontSize: 13, fontStyle: "italic" }}>
              No entries yet. Complete your first session.
            </p>
          ) : (
            <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
              {ledgerEntries.map((entry, i) => (
                <div key={i} style={{
                  background: "#141416", border: "1px solid #1E1E22",
                  borderRadius: 8, padding: "16px 20px"
                }}>
                  <p style={{ fontSize: 14, lineHeight: 1.6, margin: 0, color: "#E8E6E3" }}>
                    {entry.text}
                  </p>
                  <div style={{ display: "flex", gap: 16, marginTop: 10 }}>
                    <span style={{ fontSize: 11, color: "#555" }}>{entry.date}</span>
                    <span style={{ fontSize: 11, color: "#555" }}>vs {entry.archetype}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  }

  if (showHistory) {
    return (
      <div style={{
        minHeight: "100vh",
        background: "#0A0A0B",
        color: "#E8E6E3",
        fontFamily: "'JetBrains Mono', 'SF Mono', 'Fira Code', monospace",
        padding: "32px 24px"
      }}>
        <div style={{ maxWidth: 720, margin: "0 auto" }}>
          <button onClick={() => setShowHistory(false)} style={{
            background: "none", border: "none", color: "#666", cursor: "pointer",
            fontFamily: "inherit", fontSize: 14, marginBottom: 24, padding: 0
          }}>‚Üê Back</button>

          <h1 style={{
            fontSize: 20, fontWeight: 600, letterSpacing: "0.05em",
            textTransform: "uppercase", color: "#7B68EE", marginBottom: 8
          }}>Session History</h1>
          <p style={{ fontSize: 13, color: "#555", marginBottom: 32 }}>
            {sessions.length} session{sessions.length !== 1 ? "s" : ""} completed ¬∑ Week {weekNumber} of 12
          </p>

          {sessions.length === 0 ? (
            <p style={{ color: "#444", fontSize: 13, fontStyle: "italic" }}>No sessions yet.</p>
          ) : (
            <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
              {sessions.map((s, i) => (
                <div key={i} style={{
                  background: "#141416", border: "1px solid #1E1E22",
                  borderRadius: 8, padding: "16px 20px"
                }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
                    <span style={{ fontSize: 14, fontWeight: 600 }}>{s.archetype}</span>
                    <span style={{ fontSize: 11, color: "#555" }}>{s.date}</span>
                  </div>
                  <p style={{ fontSize: 12, color: "#888", margin: "0 0 8px 0" }}>Rule: {s.rule}</p>
                  {s.postMortem && (
                    <p style={{ fontSize: 12, color: "#666", margin: 0, lineHeight: 1.5 }}>{s.postMortem}</p>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  }

  return (
    <div style={{
      minHeight: "100vh",
      background: "#0A0A0B",
      color: "#E8E6E3",
      fontFamily: "'JetBrains Mono', 'SF Mono', 'Fira Code', monospace",
    }}>
      {/* Header */}
      <div style={{
        borderBottom: "1px solid #1A1A1E",
        padding: "20px 24px",
        display: "flex",
        justifyContent: "space-between",
        alignItems: "center"
      }}>
        <div>
          <h1 style={{
            fontSize: 15, fontWeight: 700, letterSpacing: "0.12em",
            textTransform: "uppercase", margin: 0, color: "#E8E6E3"
          }}>
            The Operator Doctrine
          </h1>
          <p style={{ fontSize: 11, color: "#555", margin: "4px 0 0 0", letterSpacing: "0.05em" }}>
            DECISION TRAINING SYSTEM ¬∑ WEEK {weekNumber}/12
          </p>
        </div>
        <div style={{ display: "flex", gap: 12 }}>
          <button onClick={() => setShowHistory(true)} style={{
            background: "#141416", border: "1px solid #2A2A2E", borderRadius: 6,
            padding: "8px 14px", color: "#888", cursor: "pointer",
            fontFamily: "inherit", fontSize: 11, letterSpacing: "0.05em"
          }}>
            HISTORY ({sessions.length})
          </button>
          <button onClick={() => setShowLedger(true)} style={{
            background: "#1A0A0A", border: "1px solid #3A1515", borderRadius: 6,
            padding: "8px 14px", color: "#DC3545", cursor: "pointer",
            fontFamily: "inherit", fontSize: 11, letterSpacing: "0.05em"
          }}>
            MISTAKE LEDGER ({ledgerEntries.length})
          </button>
        </div>
      </div>

      <div style={{ maxWidth: 800, margin: "0 auto", padding: "32px 24px" }}>
        
        {/* ‚îÄ‚îÄ‚îÄ PHASE: SELECT ARCHETYPE ‚îÄ‚îÄ‚îÄ */}
        {phase === PHASES.SELECT && (
          <div>
            <div style={{ marginBottom: 32 }}>
              <p style={{
                fontSize: 11, color: "#555", letterSpacing: "0.1em",
                textTransform: "uppercase", marginBottom: 8
              }}>Step 1</p>
              <h2 style={{ fontSize: 22, fontWeight: 600, margin: 0 }}>Select Today's Opponent</h2>
              <p style={{ fontSize: 13, color: "#666", marginTop: 8, lineHeight: 1.6 }}>
                Pick the archetype that exposes your weakest pattern.
                Not the one you're best at ‚Äî the one that catches you.
              </p>
            </div>

            <div style={{
              display: "grid",
              gridTemplateColumns: "repeat(auto-fill, minmax(340, 1fr))",
              gap: 12
            }}>
              {ARCHETYPES.map((a) => (
                <button
                  key={a.id}
                  onClick={() => {
                    setSelectedArchetype(a.id);
                    setPhase(PHASES.RULE);
                  }}
                  style={{
                    background: "#141416",
                    border: `1px solid ${selectedArchetype === a.id ? a.color : "#1E1E22"}`,
                    borderRadius: 10,
                    padding: "20px",
                    cursor: "pointer",
                    textAlign: "left",
                    transition: "all 0.2s ease",
                    position: "relative",
                    overflow: "hidden"
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.borderColor = a.color;
                    e.currentTarget.style.background = "#1A1A1E";
                  }}
                  onMouseLeave={(e) => {
                    if (selectedArchetype !== a.id) {
                      e.currentTarget.style.borderColor = "#1E1E22";
                      e.currentTarget.style.background = "#141416";
                    }
                  }}
                >
                  <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 12 }}>
                    <span style={{ fontSize: 24 }}>{a.icon}</span>
                    <span style={{ fontSize: 14, fontWeight: 600, color: "#E8E6E3", fontFamily: "inherit" }}>
                      {a.name}
                    </span>
                  </div>
                  <p style={{ fontSize: 12, color: "#777", lineHeight: 1.5, margin: "0 0 12px 0", fontFamily: "inherit" }}>
                    {a.profile}
                  </p>
                  <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                    {a.skills.map((s) => (
                      <span key={s} style={{
                        fontSize: 10, color: a.color, background: `${a.color}15`,
                        padding: "3px 8px", borderRadius: 4, fontFamily: "inherit",
                        letterSpacing: "0.03em"
                      }}>{s}</span>
                    ))}
                  </div>
                </button>
              ))}
            </div>
          </div>
        )}

        {/* ‚îÄ‚îÄ‚îÄ PHASE: SET RULE ‚îÄ‚îÄ‚îÄ */}
        {phase === PHASES.RULE && archetype && (
          <div>
            <button onClick={() => setPhase(PHASES.SELECT)} style={{
              background: "none", border: "none", color: "#555", cursor: "pointer",
              fontFamily: "inherit", fontSize: 13, padding: 0, marginBottom: 24
            }}>‚Üê Change archetype</button>

            <div style={{ marginBottom: 32 }}>
              <p style={{
                fontSize: 11, color: "#555", letterSpacing: "0.1em",
                textTransform: "uppercase", marginBottom: 8
              }}>Step 2</p>
              <h2 style={{ fontSize: 22, fontWeight: 600, margin: 0 }}>
                Set Today's Decision Rule
              </h2>
              <p style={{ fontSize: 13, color: "#666", marginTop: 8, lineHeight: 1.6 }}>
                One rule. Not two. The rule you'll install today against <span style={{ color: archetype.color }}>{archetype.name}</span>.
              </p>
            </div>

            <div style={{ marginBottom: 24 }}>
              <label style={{ fontSize: 11, color: "#555", letterSpacing: "0.05em", display: "block", marginBottom: 8 }}>
                IF [TRIGGER], THEN I [ACTION]
              </label>
              <input
                value={todayRule}
                onChange={(e) => setTodayRule(e.target.value)}
                placeholder="If they hesitate, I wait 3 seconds before speaking"
                style={{
                  width: "100%", boxSizing: "border-box",
                  background: "#141416", border: "1px solid #2A2A2E",
                  borderRadius: 8, padding: "16px", color: "#E8E6E3",
                  fontFamily: "inherit", fontSize: 14, outline: "none",
                  lineHeight: 1.5
                }}
              />
            </div>

            <div style={{ marginBottom: 32 }}>
              <button
                onClick={() => setShowRules(!showRules)}
                style={{
                  background: "none", border: "none", color: "#555",
                  cursor: "pointer", fontFamily: "inherit", fontSize: 12, padding: 0
                }}
              >
                {showRules ? "Hide" : "Show"} suggested rules ‚Üì
              </button>
              {showRules && (
                <div style={{
                  marginTop: 12, display: "flex", flexDirection: "column", gap: 6
                }}>
                  {SUGGESTED_RULES.map((rule) => (
                    <button
                      key={rule}
                      onClick={() => setTodayRule(rule)}
                      style={{
                        background: todayRule === rule ? "#1A1A2E" : "#0F0F11",
                        border: `1px solid ${todayRule === rule ? "#7B68EE40" : "#1A1A1E"}`,
                        borderRadius: 6, padding: "10px 14px", cursor: "pointer",
                        textAlign: "left", color: "#999", fontFamily: "inherit",
                        fontSize: 12, lineHeight: 1.4, transition: "all 0.15s"
                      }}
                    >
                      {rule}
                    </button>
                  ))}
                </div>
              )}
            </div>

            {todayRule.trim() && (
              <button
                onClick={() => setPhase(PHASES.BRIEF)}
                style={{
                  background: archetype.color, border: "none", borderRadius: 8,
                  padding: "14px 28px", color: "#fff", cursor: "pointer",
                  fontFamily: "inherit", fontSize: 13, fontWeight: 600,
                  letterSpacing: "0.05em"
                }}
              >
                LOCK IN RULE ‚Üí
              </button>
            )}
          </div>
        )}

        {/* ‚îÄ‚îÄ‚îÄ PHASE: BRIEF ‚îÄ‚îÄ‚îÄ */}
        {phase === PHASES.BRIEF && archetype && (
          <div>
            <div style={{
              background: "#141416", border: "1px solid #1E1E22",
              borderRadius: 12, padding: "28px", marginBottom: 32
            }}>
              <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 20 }}>
                <span style={{ fontSize: 28 }}>{archetype.icon}</span>
                <div>
                  <h2 style={{ fontSize: 18, fontWeight: 600, margin: 0, color: archetype.color }}>
                    {archetype.name}
                  </h2>
                  <p style={{ fontSize: 12, color: "#666", margin: "4px 0 0 0" }}>
                    Rep {repNumber} of 3 ¬∑ Then clean rep
                  </p>
                </div>
              </div>

              <div style={{
                background: "#0A0A0B", borderRadius: 8, padding: "16px",
                border: "1px solid #1A1A1E", marginBottom: 20
              }}>
                <p style={{ fontSize: 11, color: "#555", letterSpacing: "0.08em", textTransform: "uppercase", margin: "0 0 6px 0" }}>
                  TODAY'S RULE
                </p>
                <p style={{ fontSize: 15, color: "#E8E6E3", margin: 0, lineHeight: 1.5 }}>
                  {todayRule}
                </p>
              </div>

              <div style={{ marginBottom: 20 }}>
                <p style={{ fontSize: 11, color: "#DC3545", letterSpacing: "0.08em", textTransform: "uppercase", margin: "0 0 10px 0" }}>
                  TRAPS TO WATCH FOR
                </p>
                {archetype.traps.map((trap, i) => (
                  <p key={i} style={{ fontSize: 12, color: "#888", margin: "0 0 6px 0", lineHeight: 1.5 }}>
                    ‚Üí {trap}
                  </p>
                ))}
              </div>
            </div>

            <button
              onClick={() => {
                const prompt = generatePrompt(archetype, todayRule, repNumber);
                setCurrentPrompt(prompt);
                setPhase(PHASES.ROLEPLAY);
              }}
              style={{
                background: archetype.color, border: "none", borderRadius: 8,
                padding: "14px 28px", color: "#fff", cursor: "pointer",
                fontFamily: "inherit", fontSize: 13, fontWeight: 600,
                letterSpacing: "0.05em"
              }}
            >
              GENERATE REP {repNumber} PROMPT ‚Üí
            </button>
          </div>
        )}

        {/* ‚îÄ‚îÄ‚îÄ PHASE: ROLEPLAY ‚îÄ‚îÄ‚îÄ */}
        {phase === PHASES.ROLEPLAY && archetype && (
          <div>
            <div style={{
              display: "flex", justifyContent: "space-between", alignItems: "center",
              marginBottom: 24
            }}>
              <div>
                <span style={{ fontSize: 11, color: "#555", letterSpacing: "0.1em", textTransform: "uppercase" }}>
                  {repNumber <= 3 ? `REP ${repNumber} OF 3` : "CLEAN REP"}
                </span>
                <span style={{ color: archetype.color, marginLeft: 12, fontSize: 13 }}>
                  {archetype.icon} {archetype.name}
                </span>
              </div>
            </div>

            <div style={{
              background: "#141416", border: "1px solid #2A2A2E",
              borderRadius: 10, padding: "24px", marginBottom: 24,
              position: "relative"
            }}>
              <div style={{
                display: "flex", justifyContent: "space-between", alignItems: "center",
                marginBottom: 16
              }}>
                <p style={{ fontSize: 11, color: "#555", letterSpacing: "0.08em", margin: 0 }}>
                  COPY THIS ‚Üí PASTE INTO A NEW CLAUDE CHAT
                </p>
                <button
                  onClick={() => copyToClipboard(currentPrompt)}
                  style={{
                    background: copied ? "#28A74530" : "#1A1A1E",
                    border: `1px solid ${copied ? "#28A745" : "#333"}`,
                    borderRadius: 6, padding: "6px 14px", cursor: "pointer",
                    color: copied ? "#28A745" : "#999", fontFamily: "inherit",
                    fontSize: 11, fontWeight: 600, transition: "all 0.2s"
                  }}
                >
                  {copied ? "‚úì COPIED" : "COPY PROMPT"}
                </button>
              </div>
              <pre ref={promptRef} style={{
                fontSize: 12, color: "#999", lineHeight: 1.6,
                whiteSpace: "pre-wrap", wordBreak: "break-word",
                maxHeight: 300, overflowY: "auto", margin: 0,
                fontFamily: "inherit",
                scrollbarWidth: "thin",
                scrollbarColor: "#333 transparent"
              }}>
                {currentPrompt}
              </pre>
            </div>

            <div style={{ marginBottom: 24 }}>
              <label style={{ fontSize: 11, color: "#555", letterSpacing: "0.05em", display: "block", marginBottom: 8 }}>
                NOTES FROM THIS REP ‚Äî What happened? Where did you break?
              </label>
              <textarea
                value={repNotes[repNumber] || ""}
                onChange={(e) => setRepNotes({ ...repNotes, [repNumber]: e.target.value })}
                placeholder="I started explaining when they said 'interesting'..."
                rows={3}
                style={{
                  width: "100%", boxSizing: "border-box",
                  background: "#0F0F11", border: "1px solid #1E1E22",
                  borderRadius: 8, padding: "14px", color: "#E8E6E3",
                  fontFamily: "inherit", fontSize: 13, outline: "none",
                  resize: "vertical", lineHeight: 1.5
                }}
              />
            </div>

            <div style={{ display: "flex", gap: 12 }}>
              {repNumber < 3 ? (
                <button
                  onClick={() => {
                    const next = repNumber + 1;
                    setRepNumber(next);
                    setCurrentPrompt(generatePrompt(archetype, todayRule, next));
                  }}
                  style={{
                    background: archetype.color, border: "none", borderRadius: 8,
                    padding: "14px 24px", color: "#fff", cursor: "pointer",
                    fontFamily: "inherit", fontSize: 13, fontWeight: 600
                  }}
                >
                  NEXT REP ({repNumber + 1}/3) ‚Üí
                </button>
              ) : repNumber === 3 ? (
                <button
                  onClick={() => setPhase(PHASES.POSTMORTEM)}
                  style={{
                    background: "#DC3545", border: "none", borderRadius: 8,
                    padding: "14px 24px", color: "#fff", cursor: "pointer",
                    fontFamily: "inherit", fontSize: 13, fontWeight: 600
                  }}
                >
                  POST-MORTEM ‚Üí
                </button>
              ) : (
                <button
                  onClick={() => setPhase(PHASES.LEDGER)}
                  style={{
                    background: "#28A745", border: "none", borderRadius: 8,
                    padding: "14px 24px", color: "#fff", cursor: "pointer",
                    fontFamily: "inherit", fontSize: 13, fontWeight: 600
                  }}
                >
                  FINISH SESSION ‚Üí
                </button>
              )}
            </div>
          </div>
        )}

        {/* ‚îÄ‚îÄ‚îÄ PHASE: POSTMORTEM ‚îÄ‚îÄ‚îÄ */}
        {phase === PHASES.POSTMORTEM && archetype && (
          <div>
            <div style={{ marginBottom: 32 }}>
              <p style={{
                fontSize: 11, color: "#DC3545", letterSpacing: "0.1em",
                textTransform: "uppercase", marginBottom: 8
              }}>Post-Mortem</p>
              <h2 style={{ fontSize: 22, fontWeight: 600, margin: 0 }}>Diagnose the Failure</h2>
              <p style={{ fontSize: 13, color: "#666", marginTop: 8, lineHeight: 1.6 }}>
                Copy this prompt into the same chat where you did the roleplay.
                The AI has the context to give you a real analysis.
              </p>
            </div>

            <div style={{
              background: "#141416", border: "1px solid #2A2A2E",
              borderRadius: 10, padding: "24px", marginBottom: 24
            }}>
              <div style={{
                display: "flex", justifyContent: "space-between", alignItems: "center",
                marginBottom: 16
              }}>
                <p style={{ fontSize: 11, color: "#555", letterSpacing: "0.08em", margin: 0 }}>
                  POST-MORTEM PROMPT
                </p>
                <button
                  onClick={() => copyToClipboard(generatePostMortemPrompt(archetype, todayRule, repNotes))}
                  style={{
                    background: copied ? "#28A74530" : "#1A1A1E",
                    border: `1px solid ${copied ? "#28A745" : "#333"}`,
                    borderRadius: 6, padding: "6px 14px", cursor: "pointer",
                    color: copied ? "#28A745" : "#999", fontFamily: "inherit",
                    fontSize: 11, fontWeight: 600, transition: "all 0.2s"
                  }}
                >
                  {copied ? "‚úì COPIED" : "COPY PROMPT"}
                </button>
              </div>
              <pre style={{
                fontSize: 12, color: "#999", lineHeight: 1.6,
                whiteSpace: "pre-wrap", wordBreak: "break-word",
                maxHeight: 250, overflowY: "auto", margin: 0,
                fontFamily: "inherit"
              }}>
                {generatePostMortemPrompt(archetype, todayRule, repNotes)}
              </pre>
            </div>

            <div style={{ marginBottom: 24 }}>
              <label style={{ fontSize: 11, color: "#555", letterSpacing: "0.05em", display: "block", marginBottom: 8 }}>
                PASTE KEY FINDINGS FROM POST-MORTEM HERE
              </label>
              <textarea
                value={postMortemNote}
                onChange={(e) => setPostMortemNote(e.target.value)}
                placeholder="What the AI diagnosed..."
                rows={4}
                style={{
                  width: "100%", boxSizing: "border-box",
                  background: "#0F0F11", border: "1px solid #1E1E22",
                  borderRadius: 8, padding: "14px", color: "#E8E6E3",
                  fontFamily: "inherit", fontSize: 13, outline: "none",
                  resize: "vertical", lineHeight: 1.5
                }}
              />
            </div>

            <button
              onClick={() => {
                setRepNumber(4);
                const prompt = generatePrompt(archetype, todayRule, "rerun");
                setCurrentPrompt(prompt);
                setPhase(PHASES.ROLEPLAY);
              }}
              style={{
                background: archetype.color, border: "none", borderRadius: 8,
                padding: "14px 24px", color: "#fff", cursor: "pointer",
                fontFamily: "inherit", fontSize: 13, fontWeight: 600
              }}
            >
              GENERATE CLEAN REP ‚Üí
            </button>
          </div>
        )}

        {/* ‚îÄ‚îÄ‚îÄ PHASE: LEDGER ‚îÄ‚îÄ‚îÄ */}
        {phase === PHASES.LEDGER && archetype && (
          <div>
            <div style={{ marginBottom: 32 }}>
              <p style={{
                fontSize: 11, color: "#E8B931", letterSpacing: "0.1em",
                textTransform: "uppercase", marginBottom: 8
              }}>Final Step</p>
              <h2 style={{ fontSize: 22, fontWeight: 600, margin: 0 }}>Write Your Ledger Entry</h2>
              <p style={{ fontSize: 13, color: "#666", marginTop: 8, lineHeight: 1.6 }}>
                One sentence. What you did wrong and what the rule demanded.
              </p>
            </div>

            <div style={{ marginBottom: 24 }}>
              <input
                value={newLedgerEntry}
                onChange={(e) => setNewLedgerEntry(e.target.value)}
                placeholder='I chased agreement when they said "interesting" instead of testing ownership'
                style={{
                  width: "100%", boxSizing: "border-box",
                  background: "#141416", border: "1px solid #2A2A2E",
                  borderRadius: 8, padding: "16px", color: "#E8E6E3",
                  fontFamily: "inherit", fontSize: 14, outline: "none"
                }}
              />
            </div>

            <button
              onClick={() => {
                if (newLedgerEntry.trim()) addLedgerEntry();
                completeSession();
              }}
              style={{
                background: "#28A745", border: "none", borderRadius: 8,
                padding: "14px 28px", color: "#fff", cursor: "pointer",
                fontFamily: "inherit", fontSize: 13, fontWeight: 600
              }}
            >
              {newLedgerEntry.trim() ? "SAVE & COMPLETE SESSION" : "SKIP & COMPLETE SESSION"}
            </button>
          </div>
        )}

        {/* ‚îÄ‚îÄ‚îÄ PHASE: COMPLETE ‚îÄ‚îÄ‚îÄ */}
        {phase === PHASES.COMPLETE && (
          <div style={{ textAlign: "center", paddingTop: 60 }}>
            <div style={{
              fontSize: 48, marginBottom: 24
            }}>‚úì</div>
            <h2 style={{ fontSize: 22, fontWeight: 600, margin: "0 0 12px 0" }}>Session Complete</h2>
            <p style={{ fontSize: 14, color: "#666", marginBottom: 8 }}>
              Session {sessions.length} ¬∑ Week {weekNumber} of 12
            </p>
            <p style={{ fontSize: 13, color: "#444", marginBottom: 40, maxWidth: 400, margin: "0 auto 40px" }}>
              {sessions.length % 5 === 0
                ? `Week ${weekNumber} complete. ${12 - weekNumber} weeks remaining.`
                : `${5 - (sessions.length % 5)} sessions until you finish week ${weekNumber}.`
              }
            </p>
            <div style={{ display: "flex", gap: 12, justifyContent: "center" }}>
              <button
                onClick={resetSession}
                style={{
                  background: "#141416", border: "1px solid #2A2A2E", borderRadius: 8,
                  padding: "14px 28px", color: "#E8E6E3", cursor: "pointer",
                  fontFamily: "inherit", fontSize: 13, fontWeight: 600
                }}
              >
                NEW SESSION
              </button>
              <button
                onClick={() => { resetSession(); setShowLedger(true); }}
                style={{
                  background: "#1A0A0A", border: "1px solid #3A1515", borderRadius: 8,
                  padding: "14px 28px", color: "#DC3545", cursor: "pointer",
                  fontFamily: "inherit", fontSize: 13, fontWeight: 600
                }}
              >
                REVIEW LEDGER
              </button>
            </div>
          </div>
        )}

      </div>
    </div>
  );
}
